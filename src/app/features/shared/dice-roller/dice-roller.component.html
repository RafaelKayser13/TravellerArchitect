<div class="dice-overlay" *ngIf="request">
    <app-hud-window
        [isOpen]="true"
        [title]="request.reason"
        [width]="'700px'"
        type="standard"
        readoutTL="SIG_LOCK: STABLE"
        [readoutTR]="'PROC_ID: ' + (Math.random() * 99999).toFixed(0)"
        readoutBL="VOLTAGE: 4.2V"
        readoutBR="PARITY: PASS">

        <!-- Two Column Content -->
        <div class="hud-dual-wrapper">
            <!-- Left: Input/Stats & Table Overlay -->
            <div class="hud-column input-sec">
                <div class="column-header">
                    <span class="prefix">>></span> DATA_CONTEXT
                </div>

                <!-- TABLE OVERLAY (NEW) -->
                <div class="table-overlay-container" *ngIf="tableRows.length > 0">
                    <span class="label-tiny">PROBABILITY_MATRIX / OUTCOMES</span>
                    <div class="outcomes-table">
                        <div class="outcome-row" *ngFor="let row of tableRows" [class.active]="row.active">
                            <span class="roll-val">{{ row.roll }}</span>
                            <span class="outcome-desc">{{ row.value }}</span>
                            <div class="active-indicator" *ngIf="row.active"></div>
                        </div>
                    </div>
                </div>

                <div class="context-details" *ngIf="tableRows.length === 0">
                    <div class="side-by-side">
                        <div class="detail-box" *ngIf="request.statName">
                            <span class="label">VECTOR_IN</span>
                            <div class="value">{{ request.statName }}</div>
                        </div>
                        <div class="detail-box" *ngIf="request.target > 0">
                            <span class="label">THRESHOLD</span>
                            <div class="value">{{ request.target }}+</div>
                        </div>
                    </div>

                    <div class="modifiers-container"
                        *ngIf="(request.modifiers && request.modifiers.length > 0) || request.dm !== 0">
                        <span class="label-tiny">ACTIVE_MODIFIERS</span>
                        <div class="modifiers-list">
                            <div class="mod-pill" *ngFor="let mod of request.modifiers" [class.pos]="mod.value > 0"
                                [class.neg]="mod.value < 0">
                                <span class="mod-desc">{{mod.label}}:</span>
                                <span class="mod-val">{{mod.value > 0 ? '+' : ''}}{{mod.value}}</span>
                            </div>
                            <div class="mod-pill"
                                *ngIf="(!request.modifiers || request.modifiers.length === 0) && request.dm !== 0"
                                [class.pos]="request.dm > 0" [class.neg]="request.dm < 0">
                                NET_OFFSET: {{ request.dm >= 0 ? '+' : ''}}{{ request.dm }}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="status-leds">
                    <div class="led" [class.active]="true"></div>
                    <div class="led" [class.active]="rolling"></div>
                    <div class="led" [class.active]="showResult"></div>
                </div>
            </div>

            <!-- Right: Processing & Results (Dual Stack) -->
            <div class="hud-column processing-sec">
                <div class="column-header center">
                    <span class="prefix">::</span> TACTICAL_DICE_SCAN <span class="prefix">::</span>
                </div>
                <div class="dice-stack">
                    <div class="dice-area">
                        <ng-container *ngIf="rolling">
                            <div class="cube-spinner" *ngFor="let d of [].constructor(request.diceCount || 2)">
                                <div class="cube scanning">
                                    <div class="face front">?</div>
                                    <div class="face back">?</div>
                                    <div class="face right">?</div>
                                    <div class="face left">?</div>
                                    <div class="face top">?</div>
                                    <div class="face bottom">?</div>
                                </div>
                            </div>
                        </ng-container>

                        <ng-container *ngIf="showResult">
                            <div class="cube-result" *ngFor="let val of resultValues">
                                <div class="cube show-{{val}}">
                                    <div class="face front">1</div>
                                    <div class="face back">6</div>
                                    <div class="face right">3</div>
                                    <div class="face left">4</div>
                                    <div class="face top">5</div>
                                    <div class="face bottom">2</div>
                                </div>
                            </div>
                        </ng-container>
                    </div>

                    <div class="data-stream" *ngIf="rolling">
                        0101010101011101010101010101110101
                    </div>

                    <!-- Moved Results here, below dice area -->
                    <div class="total-display" *ngIf="showResult">
                        <div class="calc-row">
                            <div class="part">
                                {{ total }}
                                <span class="tiny">RAW</span>
                            </div>
                            <div class="operator">+</div>
                            <div class="part">
                                {{ request.dm }}
                                <span class="tiny">MODS</span>
                            </div>
                        </div>

                        <div class="final-row">
                            <div class="final-val-wrapper">
                                <span class="final-val" *ngIf="!diceService.debugMode()">{{ effectiveTotal }}</span>
                                <input *ngIf="diceService.debugMode()" 
                                       type="number" 
                                       class="debug-roll-input" 
                                       [value]="total"
                                       (input)="updateManualTotal($event)"
                                       title="DEBUG: Override base roll (Total = Base + Mods)">
                            </div>
                            <div class="status" *ngIf="request && request.target > 0">
                                <span class="success" *ngIf="isSuccess">OP_SUCCESS</span>
                                <span class="fail" *ngIf="!isSuccess">OP_FAILURE</span>
                            </div>
                        </div>
                    </div>

                    <!-- Event / Result Description -->
                    <div class="result-description" *ngIf="showResult && resultDescription">
                        {{ resultDescription }}
                    </div>
                </div>
            </div>
        </div>

        <ng-container footer>
            <div class="action-wrapper" *ngIf="showResult">
                <button class="btn-continue" (click)="continue()">
                    [ NEXT_PROTOCOL ]
                </button>
            </div>
        </ng-container>

    </app-hud-window>
</div>
