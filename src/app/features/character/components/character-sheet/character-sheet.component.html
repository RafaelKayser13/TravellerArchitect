<div class="sheet-container fade-in">
    <!-- Header Section: Identity & Biometrics -->
    <header class="dossier-header">
        <div class="hud-box-header">
            <span class="index">DOSSIER_ID: {{ character().id || 'PENDING_REGISTRATION' }}</span>
            <div class="player-tag" *ngIf="character().playerName">
                <span class="m-label">PLAYER:</span>
                <span class="m-val">{{ character().playerName }}</span>
            </div>
            <h3>TACTICAL_CHARACTER_SUMMARY</h3>
        </div>

        <div class="identity-grid-v2">
            <!-- Portrait Column (Visual Recon) -->
            <div class="portrait-column">
                <div class="portrait-frame">
                    <img *ngIf="character().portraitUrl" [src]="character().portraitUrl" alt="Portrait">
                    <div *ngIf="!character().portraitUrl" class="no-signal">
                        <span class="glitch-text">NO_SIGNAL</span>
                    </div>
                </div>
            </div>

            <!-- Identity Info (Classified Data) -->
            <div class="id-info-column">
                <div class="field large">
                    <span class="label">SUBJECT_NAME</span>
                    <div class="value-row">
                        <span class="value">{{ character().name || 'UNNAMED_OPERATIVE' }}</span>
                        <span class="nickname" *ngIf="character().nickname">"{{ character().nickname }}"</span>
                    </div>
                </div>

                <div class="metadata-grid">
                    <div class="meta-item">
                        <span class="m-label">SPECIES</span>
                        <span class="m-val highlight">{{ character().species }}</span>
                    </div>
                    <div class="meta-item">
                        <span class="m-label">ORIGIN</span>
                        <span class="m-val">{{ character().originType }}</span>
                    </div>
                    <div class="meta-item">
                        <span class="m-label">EST_AGE</span>
                        <span class="m-val">{{ character().age }} STANDARD_YEARS</span>
                    </div>
                    <div class="meta-item">
                        <span class="m-label">PHENOTYPE</span>
                        <span class="m-val highlight">{{ character().gender }}</span>
                    </div>
                    <div class="meta-item">
                        <span class="m-label">AUTH_LEVEL</span>
                        <span class="m-val yellow">SEC_CLEARANCE_0{{ character().careerHistory.length }}</span>
                    </div>
                </div>

                <div class="biometrics-row" *ngIf="character().description">
                    <span class="m-label">PHYSICAL_BIO:</span>
                    <p class="bio-text">{{ character().description }}</p>
                </div>
            </div>
        </div>
    </header>

    <div class="dossier-grid">
        <!-- Characteristics Column -->
        <aside class="characteristics-column">
            <div class="hud-module stats">
                <div class="hud-box-header">
                    <span class="index">CH_01</span>
                    <h3>CORE_CHARACTERISTICS</h3>
                </div>
                <div class="hud-content">
                    <div class="stat-grid-sheet">
                        <div class="stat-box-sheet">
                            <span class="s-name">STR</span>
                            <span class="s-val">{{ character().characteristics.str.value }}</span>
                            <span class="s-mod" [class.pos]="character().characteristics.str.modifier >= 0">
                                {{ character().characteristics.str.modifier >= 0 ? '+' : '' }}{{
                                character().characteristics.str.modifier }}
                            </span>
                        </div>
                        <div class="stat-box-sheet">
                            <span class="s-name">DEX</span>
                            <span class="s-val">{{ character().characteristics.dex.value }}</span>
                            <span class="s-mod" [class.pos]="character().characteristics.dex.modifier >= 0">
                                {{ character().characteristics.dex.modifier >= 0 ? '+' : '' }}{{
                                character().characteristics.dex.modifier }}
                            </span>
                        </div>
                        <div class="stat-box-sheet">
                            <span class="s-name">END</span>
                            <span class="s-val">{{ character().characteristics.end.value }}</span>
                            <span class="s-mod" [class.pos]="character().characteristics.end.modifier >= 0">
                                {{ character().characteristics.end.modifier >= 0 ? '+' : '' }}{{
                                character().characteristics.end.modifier }}
                            </span>
                        </div>
                        <div class="stat-box-sheet">
                            <span class="s-name">INT</span>
                            <span class="s-val">{{ character().characteristics.int.value }}</span>
                            <span class="s-mod" [class.pos]="character().characteristics.int.modifier >= 0">
                                {{ character().characteristics.int.modifier >= 0 ? '+' : '' }}{{
                                character().characteristics.int.modifier }}
                            </span>
                        </div>
                        <div class="stat-box-sheet">
                            <span class="s-name">EDU</span>
                            <span class="s-val">{{ character().characteristics.edu.value }}</span>
                            <span class="s-mod" [class.pos]="character().characteristics.edu.modifier >= 0">
                                {{ character().characteristics.edu.modifier >= 0 ? '+' : '' }}{{
                                character().characteristics.edu.modifier }}
                            </span>
                        </div>
                        <div class="stat-box-sheet">
                            <span class="s-name">SOC</span>
                            <span class="s-val">{{ character().characteristics.soc.value }}</span>
                            <span class="s-mod" [class.pos]="character().characteristics.soc.modifier >= 0">
                                {{ character().characteristics.soc.modifier >= 0 ? '+' : '' }}{{
                                character().characteristics.soc.modifier }}
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Origin & Homeworld -->
            <div class="hud-module world" *ngIf="character().homeworld">
                <div class="hud-box-header">
                    <span class="index">OR_01</span>
                    <h3>HOMEWORLD_ORIGIN</h3>
                </div>
                <div class="hud-content">
                    <div class="world-data">
                        <div class="w-primary">
                            <span class="w-name">{{ character().homeworld?.name }}</span>
                            <span class="w-uwp">{{ character().homeworld?.uwp }}</span>
                        </div>
                        <div class="tactical-row mini">
                            <div class="t-item">
                                <span class="t-label">GRAVITY</span>
                                <span class="t-val">{{ character().homeworld?.gravity }}G ({{
                                    character().homeworld?.gravityCode }})</span>
                            </div>
                            <div class="t-item">
                                <span class="t-label">NATION</span>
                                <span class="t-val">{{ character().nationality }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Finances & Assets -->
            <div class="hud-module finances">
                <div class="hud-box-header">
                    <span class="index">FN_01</span>
                    <h3>ECONOMIC_STATUS_DATA</h3>
                </div>
                <div class="hud-content">
                    <div class="finance-grid">
                        <div class="f-item">
                            <span class="f-label">LIQUID_CASH</span>
                            <span class="f-val highlight">Lv {{ character().finances.cash | number:'1.0-0' }}</span>
                        </div>
                        <div class="f-item" *ngIf="character().finances.shipShares > 0">
                            <span class="f-label">SHIP_SHARES</span>
                            <span class="f-val">{{ character().finances.shipShares }} UNIT(S)</span>
                        </div>
                        <div class="f-item" *ngIf="character().finances.debt > 0">
                            <span class="f-label debt">FINANCIAL_DEBT</span>
                            <span class="f-val danger">Lv {{ character().finances.debt | number:'1.0-0' }}</span>
                        </div>
                        <div class="f-item" *ngIf="characterService.pension() > 0">
                            <span class="f-label">ANNUAL_PENSION</span>
                            <span class="f-val">Lv {{ characterService.pension() * 10000 | number:'1.0-0' }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Skills & Status Column -->
        <main class="data-column">
            <!-- 1. Skills Hierarchical Matrix -->
            <div class="hud-module skills">
                <div class="hud-box-header">
                    <span class="index">SK_01</span>
                    <h3>SKILL_HIERARCHY_ARRAY</h3>
                </div>
                <div class="hud-content">
                    <div class="skill-tree">
                        <!-- Grouped Skills -->
                        <div class="skill-group" *ngFor="let group of skillsTree().groups">
                            <div class="group-header">
                                <span class="g-name">{{ group.name }}</span>
                                <span class="g-line"></span>
                            </div>
                            <div class="group-children">
                                <div class="skill-entry mini" *ngFor="let child of group.children">
                                    <span class="s-name">>> {{ child.specialization }}</span>
                                    <span class="s-lvl">LV.{{ child.level }}</span>
                                </div>
                            </div>
                        </div>
                        <!-- Standalone Skills -->
                        <div class="skill-entry" *ngFor="let skill of skillsTree().standalone">
                            <div class="s-header">
                                <span class="s-name">{{ skill.name }}</span>
                                <span class="s-lvl">LV.{{ skill.level }}</span>
                                <span class="s-spec" *ngIf="skill.specialization">[{{ skill.specialization }}]</span>
                            </div>
                        </div>
                        <div class="empty-state" *ngIf="character().skills.length === 0">
                            [ NO_ACTIVE_SKILL_SIGNALS ]
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2. Status & Medical Section (Injuries / Implants) -->
            <div class="status-grid">
                <!-- Injuries -->
                <div class="hud-module status medical">
                    <div class="hud-box-header">
                        <span class="index">MD_01</span>
                        <h3>TRAUMA_LOG</h3>
                    </div>
                    <div class="hud-content">
                        <div class="injury-list">
                            <div class="injury-item" *ngFor="let injury of character().injuries"
                                [class.treated]="injury.treated">
                                <span class="marker" [class.danger]="!injury.treated" [class.success]="injury.treated">
                                    {{ injury.treated ? 'âœ“' : '!!' }}
                                </span>
                                <div class="injury-info">
                                    <span class="item-name">{{ injury.name }}</span>
                                    <span class="item-stat" *ngIf="!injury.treated">[{{ injury.stat }} -{{
                                        injury.reduction }}]</span>
                                    <span class="item-treated" *ngIf="injury.treated">RESTORED</span>
                                </div>
                            </div>
                            <div class="empty-state" *ngIf="character().injuries.length === 0">
                                [ NO_TRAUMA_DETECTED ]
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Implants -->
                <div class="hud-module status cyber">
                    <div class="hud-box-header">
                        <span class="index">CB_01</span>
                        <h3>CYBER_INTEGRATION</h3>
                    </div>
                    <div class="hud-content">
                        <div class="implant-list">
                            <div class="implant-item" *ngFor="let item of implants()">
                                <span class="marker yellow">++</span>
                                <span class="item-name">{{ item }}</span>
                            </div>
                            <div class="empty-state" *ngIf="implants().length === 0">
                                [ NO_AUGMENTATIONS_FOUND ]
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 3. Relationship Matrix -->
            <div class="hud-module relationships">
                <div class="hud-box-header">
                    <span class="index">RS_01</span>
                    <h3>SOCIAL_RELATIONSHIP_MATRIX</h3>
                </div>
                <div class="hud-content">
                    <div class="relationship-grid">
                        <div class="npc-type-group" *ngFor="let group of categorizedNpcs()">
                            <span class="type-label" [class]="group.type.toLowerCase()">{{ group.type }}</span>
                            <div class="npc-list">
                                <div class="npc-card" *ngFor="let npc of group.list">
                                    <span class="n-name">{{ npc.name }}</span>
                                    <span class="n-origin">{{ npc.origin }}</span>
                                </div>
                            </div>
                        </div>
                        <div class="empty-state" *ngIf="character().npcs.length === 0">
                            [ NO_RELATIONSHIP_NETWORKS ]
                        </div>
                    </div>
                </div>
            </div>

            <!-- 4. Career Timeline -->
            <div class="hud-module chronology">
                <div class="hud-box-header">
                    <span class="index">CH_02</span>
                    <h3>SERVICE_RECORD_CHRONOLOGY</h3>
                </div>
                <div class="hud-content history-terminal">
                    <div class="history-entry" *ngFor="let term of character().careerHistory">
                        <div class="h-timeline">
                            <span class="h-term">TERM_0{{ term.termNumber }}</span>
                        </div>
                        <div class="h-details">
                            <div class="h-main">
                                <span class="h-career">{{ term.careerName }}</span>
                                <span class="h-rank" *ngIf="term.rankTitle">{{ term.rankTitle }} (R{{ term.rank
                                    }})</span>
                                <span class="h-rank" *ngIf="!term.rankTitle">RANK_0{{ term.rank }}</span>
                            </div>
                            <div class="h-assignment" *ngIf="term.assignment">ASSIGNMENT: {{ term.assignment }}</div>
                            <div class="h-events">
                                <div class="ev-item" *ngFor="let ev of term.events">
                                    <span class="dot"></span>
                                    <span class="text">{{ ev }}</span>
                                </div>
                            </div>
                            <div class="h-benefits" *ngIf="term.benefits.length > 0">
                                <span class="hud-label-tiny">TOTAL_BENEFITS:</span>
                                <span class="benefit-tag" *ngFor="let b of term.benefits">{{ b }}</span>
                            </div>
                        </div>
                    </div>
                    <div class="empty-state" *ngIf="character().careerHistory.length === 0">
                        [ NO_SERVICE_HISTORY_FOUND ]
                    </div>
                </div>
            </div>

            <!-- 5. General Inventory -->
            <div class="hud-module equipment" *ngIf="generalEquipment().length > 0">
                <div class="hud-box-header">
                    <span class="index">EQ_01</span>
                    <h3>GENERAL_INVENTORY</h3>
                </div>
                <div class="hud-content">
                    <div class="inventory-grid">
                        <div class="inv-item" *ngFor="let item of generalEquipment()">
                            <span class="marker">>></span>
                            <span class="item-name">{{ item }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Actions Footer -->
    <footer class="sheet-actions-footer">
        <div class="divider"></div>
        <div class="action-buttons">
            <button class="btn-action-sheet" (click)="exportJson()" id="btn-export-json">
                <span class="index">CMD_01</span>
                EXPORT_DATA_JSON
            </button>
            <button class="btn-action-sheet finalize" (click)="exportPdf()" id="btn-export-pdf">
                <span class="index">CMD_02</span>
                PRINT_OFFICIAL_DOSSIER
            </button>
        </div>
    </footer>
</div>