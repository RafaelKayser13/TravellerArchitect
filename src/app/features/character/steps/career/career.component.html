<div class="career-container">
    <h2>Term {{ currentTerm() }} (Age {{ currentAge() }})</h2>
    
    <!-- 1. CHOOSE CAREER -->
    <div *ngIf="currentState() === 'CHOOSE_CAREER'" class="career-selection">
        <h3>Choose Career</h3>
        <div class="career-list">
            <div *ngFor="let career of careers" 
                 class="career-card" 
                 [class.selected]="selectedCareer === career"
                 (click)="selectCareer(career)">
                <h4>{{ career.name }}</h4>
                <p>{{ career.description }}</p>
                <small>Qual: {{ career.qualificationStat }} {{ career.qualificationTarget }}+</small>
            </div>
        </div>
        
        <div *ngIf="selectedCareer" class="assignment-list" id="assignment-list">
            <h4>Select Assignment</h4>
            <div *ngFor="let assign of selectedCareer.assignments"
                 class="assignment-card"
                 [class.selected]="selectedAssignment === assign"
                 (click)="selectAssignment(assign)">
                 <h5>{{ assign.name }}</h5>
                 <p>Survival: {{ assign.survivalStat }} {{ assign.survivalTarget }}+</p>
            </div>
        </div>
        
        <div class="selection-actions">
            <button *ngIf="selectedAssignment" id="qualify-btn" class="btn-premium" (click)="qualify()">Attempt Qualification</button>
            <button *ngIf="characterService.character().careerHistory.length > 0" class="btn-success large finalize-btn" (click)="startMusteringOut()">
                Finalize Character & Muster Out
            </button>
        </div>
    </div>
    
    <!-- STATE: BASIC_TRAINING -->
    <div *ngIf="currentState() === 'BASIC_TRAINING'" class="action-card success fade-in">
        <div class="card-header">
            <h3>Basic Training / Commission</h3>
        </div>
        <div class="card-content">
            <p>You have joined the <strong>{{ selectedCareer?.name }}</strong>.</p>
            <p *ngIf="currentTerm() === 1">First Term: You receive all Service Skills at Level 0.</p>
        </div>
        <div class="card-actions">
            <!-- Go to SKILL_TRAINING next -->
            <button class="btn-premium" (click)="performBasicTraining()">Proceed to Training</button>
            <button class="btn-secondary" (click)="attemptCommission()" *ngIf="canAttemptCommission()">Attempt Commission</button>
        </div>
    </div>

    <!-- STATE: SKILL_TRAINING -->
    <div *ngIf="currentState() === 'SKILL_TRAINING'" class="action-card info fade-in">
        <div class="card-header">
            <h3>{{ bonusSkillRolls() > 0 ? 'Bonus Skill Roll' : 'Skill Training' }}</h3>
        </div>
        <div class="card-content">
            <p class="instruction">Select a table to roll for a skill or attribute improvement.</p>
            
            <div class="skill-tables">
                <button class="table-btn" (click)="rollSkill('Personal')">
                    Personal Development
                    <small>Str, Dex, End, Int...</small>
                </button>
                <button class="table-btn" (click)="rollSkill('Service')">
                    Service Skills
                    <small>Career Core Skills</small>
                </button>
                 <button class="table-btn" (click)="rollSkill('Specialist')" *ngIf="selectedAssignment">
                    Specialist: {{ selectedAssignment.name }}
                    <small>Assignment Focus</small>
                </button>
                <button class="table-btn" (click)="rollSkill('Advanced')" [disabled]="characterService.character().characteristics.edu.value < 8">
                    Advanced Education
                    <small>Req: EDU 8+</small>
                </button>
                <button class="table-btn" (click)="rollSkill('Officer')" *ngIf="selectedCareer?.officerSkills" [disabled]="!isCommissioned()">
                    Officer Skills
                    <small>Req: Commission</small>
                </button>
            </div>
        </div>
    </div>
    
    <!-- SPECIALIZATION MODAL -->
    <div *ngIf="showSkillSelection" class="modal-overlay">
        <div class="modal">
            <h3>Specialization Required: {{ pendingSkillName }}</h3>
            <div class="grid-options">
                <button *ngFor="let opt of skillSelectionOptions" 
                        class="btn-secondary" 
                        (click)="confirmSpecialization(opt)">
                    {{ opt }}
                </button>
            </div>
        </div>
    </div>

    <!-- STATE: SURVIVAL -->
    <div *ngIf="currentState() === 'SURVIVAL'" class="action-card warning fade-in">
        <div class="card-header">
            <h3>Survival Check</h3>
            <span class="difficulty-badge">Target: {{ selectedAssignment?.survivalTarget }}+</span>
        </div>
        
        <div class="card-content">
            <div class="stat-row">
                <div class="stat-item">
                    <span class="label">Stat</span>
                    <span class="value">{{ selectedAssignment?.survivalStat }}</span>
                </div>
                <div class="stat-item">
                    <span class="label">Assignment</span>
                    <span class="value">{{ selectedAssignment?.name }}</span>
                </div>
            </div>
            
            <p class="instruction">Risk checks are mandatory for every term of service.</p>
            
            <div *ngIf="showCyberneticOption" class="alert-box error">
                <strong>Survival Failed!</strong>
                <p>You face a mishap. You may accept a Cybernetic Implant (and lose 1 Benefit Roll) to remain in this career.</p>
                <div class="alert-actions">
                    <button class="btn-secondary" (click)="resolveSurvivalFailure(true)">Accept Implant (Stay)</button>
                    <button class="btn-danger" (click)="resolveSurvivalFailure(false)">Accept Mishap (Eject)</button>
                </div>
            </div>
        </div>

        <div *ngIf="!showCyberneticOption" class="card-actions">
             <button class="btn-premium large" (click)="rollSurvival()">
                 ROLL SURVIVAL
                 <span class="sub-text">2D6 + {{ selectedAssignment?.survivalStat }} DM</span>
             </button>
        </div>
    </div>
    
    <!-- STATE: EVENT / MISHAP -->
    <div *ngIf="currentState() === 'EVENT' || currentState() === 'MISHAP'" class="action-card fade-in" [class.mishap-card]="currentState() === 'MISHAP'">
        <div class="card-header">
            <h3>{{ currentState() === 'MISHAP' ? 'MISHAP' : 'CAREER EVENT' }}</h3>
        </div>
        <div class="card-content">
            <p class="event-text">{{ currentEventText }}</p>
        </div>
        
        <div class="card-actions">
            <!-- UPDATED: Use proceedToAdvancement() -->
            <button *ngIf="currentState() === 'EVENT'" class="btn-premium" (click)="proceedToAdvancement()">Proceed</button>
            <button *ngIf="currentState() === 'MISHAP'" class="btn-danger" (click)="finishTerm('MUSTER')">Mustering Out (Forced)</button>
        </div>
    </div>
    
    <!-- STATE: ADVANCEMENT -->
    <div *ngIf="currentState() === 'ADVANCEMENT'" class="action-card info fade-in">
        <div class="card-header">
            <h3>Advancement Check</h3>
            <span class="difficulty-badge">Target: {{ selectedAssignment?.advancementTarget }}+</span>
        </div>
        <div class="card-content">
            <div class="stat-row">
                <div class="stat-item">
                     <span class="label">Stat</span>
                     <span class="value">{{ selectedAssignment?.advancementStat }}</span>
                </div>
            </div>
            <p class="instruction">Roll for promotion and increased benefits.</p>
        </div>
        
        <div class="card-actions">
            <button class="btn-premium large" (click)="rollAdvancement()">
                ROLL ADVANCEMENT
                <span class="sub-text">2D6 + {{ selectedAssignment?.advancementStat }} DM</span>
            </button>
        </div>
    </div>
    
    <!-- STATE: CHANGE ASSIGNMENT -->
    <div *ngIf="currentState() === 'CHANGE_ASSIGNMENT'" class="career-selection fade-in">
        <h3>Change Assignment ({{ selectedCareer?.name }})</h3>
        <p class="instruction" style="text-align: center; color: #aaa;">Select a new assignment. Qualification roll required.</p>
        
        <div class="assignment-list">
            <div *ngFor="let assign of selectedCareer?.assignments"
                 class="assignment-card"
                 (click)="verifyAssignmentChange(assign)">
                 <h5>{{ assign.name }}</h5>
                 <p>Qual: {{ selectedCareer?.qualificationStat }} {{ selectedCareer?.qualificationTarget }}+</p>
            </div>
        </div>
        
        <div class="card-actions">
            <button class="btn-secondary" (click)="finishTerm('CONTINUE')">Cancel (Stay in Current)</button>
        </div>
    </div>
    
    <!-- Leaving Home Check -->
    <div class="action-card fade-in" *ngIf="currentState() === 'LEAVING_HOME'">
        <div class="card-header">
            <h3>Leaving Home</h3>
        </div>
        <div class="card-content">
             <p>You are still tied to your homeworld. Passing this check represents establishing independence.</p>
             <div class="stat-row">
                 <div class="stat-item">
                     <span class="label">Target</span>
                     <span class="value">8+</span>
                 </div>
                 <div class="stat-item">
                     <span class="label">Bonus</span>
                     <span class="value">+{{ currentTerm() }} (Terms)</span>
                 </div>
             </div>
        </div>
        <div class="card-actions">
            <button class="btn-premium" (click)="rollLeavingHome()">Attempt to Leave</button>
        </div>
    </div>

    <!-- Term End -->
    <div class="action-card fade-in" *ngIf="currentState() === 'TERM_END'">
        <div class="card-header">
            <h3>End of Term {{ currentTerm() - 1 }}</h3>
        </div>
        <div class="card-content">
            <div class="term-summary">
                <div class="summary-item" [class.success]="success">
                    <span class="label">Advancement:</span>
                    <span class="val">{{ success ? 'Promoted' : 'None' }}</span>
                </div>
                <div class="summary-item" *ngIf="leavingHomeSuccess">
                    <span class="label">Status:</span>
                    <span class="val">Left Home</span>
                </div>
            </div>
            
            <div *ngIf="mandatoryContinue" class="alert-box info"><strong>Mandatory Continuation!</strong> You rolled a 12 and must continue.</div>
            <div *ngIf="forcedOut" class="alert-box error"><strong>Forced Out!</strong> You must muster out this term.</div>
        </div>
        <div class="card-actions">
             <button class="btn-premium" (click)="continueCareer()" [disabled]="forcedOut">Start Next Term</button>
             <button class="btn-secondary" (click)="startChangeAssignment()" [disabled]="mandatoryContinue || forcedOut">Change Assignment</button>
             <button class="btn-secondary" (click)="finishTerm('MUSTER')" [disabled]="mandatoryContinue">Muster Out</button>
        </div>
    </div>
    


</div>
