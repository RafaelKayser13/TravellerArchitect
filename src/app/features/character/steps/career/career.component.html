<div class="career-container">
    <app-step-header stepSymbol="SEC" stepNumber="06" superLabel="SERVICE_HISTORY_PROTOCOL" topLabel="CHRONOS_STATUS"
        title="CAREER_SERVICE_RECORDS" subtitle="Term {{ currentTerm() }} (Age {{ currentAge() }})">
    </app-step-header>

    <!-- 1. CHOOSE CAREER -->
    <div *ngIf="currentState() === 'CHOOSE_CAREER'" class="career-stack fade-in">
        <div class="hud-box-header">
            <span class="index">SEC_04</span>
            <h3>CAREER_SELECTION_PROTOCOL</h3>
        </div>

        <div class="career-list">
            <div *ngFor="let career of careers; let i = index" class="career-card"
                [class.selected]="selectedCareer === career" 
                [class.disabled]="isCareerDisabled(career)"
                (click)="selectCareer(career)">

                <div class="card-layout">
                    <!-- Info Column -->
                    <div class="info-column">
                        <div class="card-header">
                            <span class="index">0{{i+1}}</span>
                            <h3>{{ career.name }}</h3>
                        </div>
                        <div class="details">
                            <p><span class="label">QUALIFICATION:</span> <span class="highlight">{{
                                    career.qualificationStat
                                    }} {{ career.qualificationTarget }}+</span></p>
                            <div class="description-text">{{ career.description }}</div>
                            
                            <!-- New: Disabled Reason -->
                            <div *ngIf="isCareerDisabled(career)" class="disabled-reason">
                                <span class="icon">âš </span> {{ getDisabledReason(career) }}
                            </div>
                        </div>
                    </div>

                    <!-- Config Column (Active only when selected) -->
                    <div class="config-column" *ngIf="selectedCareer === career" (click)="$event.stopPropagation()">
                        <div class="assignment-selector">
                            <span class="hud-label">[ SELECT_ASSIGNMENT_SPECIALIZATION ]</span>
                            <div class="radio-tab-group">
                                <label class="radio-tab" *ngFor="let assign of career.assignments">
                                    <input type="radio" name="assignment" [value]="assign"
                                        [checked]="selectedAssignment === assign" (change)="selectAssignment(assign)" />
                                    <div class="tab-content">
                                        <span class="primary">{{ assign.name }}</span>
                                        <span class="secondary">SRV: {{ assign.survivalStat }} {{ assign.survivalTarget
                                            }}+</span>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <div class="card-footer-actions">
                            <button class="btn-action" [disabled]="!selectedAssignment" (click)="qualify()">
                                {{ characterService.character().forcedCareer === selectedCareer.name ? 'CONFIRM_ENROLLMENT' : 'ATTEMPT_QUALIFICATION' }}
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Career Finalization / Global Actions -->
        <div class="global-actions" *ngIf="characterService.character().careerHistory.length > 0">
            <div class="divider"></div>
            <button class="btn-action finalize" (click)="startMusteringOut()">
                FINALIZE_SERVICE_RECORD & MUSTER_OUT
            </button>
        </div>
    </div>

    <!-- 1b. QUALIFICATION FAILURE (Term 1 Fallback) -->
    <div *ngIf="currentState() === 'QUALIFICATION_FAILURE'" class="hud-module error fade-in">
        <div class="corner-detail tl"></div>
        <div class="corner-detail tr"></div>
        <div class="corner-detail bl"></div>
        <div class="corner-detail br"></div>
        <div class="hud-box-header">
            <span class="index">SEC_04A</span>
            <h3>QUALIFICATION_FAILURE_FALLBACK</h3>
        </div>
        <div class="hud-content">
            <p class="hud-alert error">ENTRY_DENIED: Personnel failed to qualify for the selected career path.</p>
            <p class="instruction">In accordance with 2300AD Service Protocols, select one fallback vector:</p>
            
            <div class="action-grid">
                <button class="btn-action warn" (click)="chooseDraft()">
                    <span class="primary">THE_DRAFT</span>
                    <span class="secondary">MANDATORY_PLACEMENT (DICE_ROLL)</span>
                </button>
                <button class="btn-action" (click)="chooseDrifter()">
                    <span class="primary">DRIFTER_LIFE</span>
                    <span class="secondary">VOLUNTARY_UNSKILLED_SERVICE</span>
                </button>
            </div>
        </div>
        <div class="hud-footer">
            <p class="status-msg">[ NOTE ]: Accepting the Draft results in a random career. Drifter ensures immediate placement.</p>
        </div>
    </div>

    <!-- STATE: BASIC_TRAINING -->
    <div *ngIf="currentState() === 'BASIC_TRAINING'" class="hud-module success fade-in">
        <div class="corner-detail tl"></div>
        <div class="corner-detail tr"></div>
        <div class="corner-detail bl"></div>
        <div class="corner-detail br"></div>
        <div class="hud-box-header">
            <span class="index">SEC_04B</span>
            <h3>BASIC_TRAINING_PROTOCOL</h3>
        </div>
        <div class="hud-content">
            <p>Personnel has successfully matriculated into the <span class="highlight">{{ selectedCareer?.name
                    }}</span>.
            </p>
            <p *ngIf="currentTerm() === 1" class="status-msg">[ INITIAL_QUALIFICATION_RECOGNIZED ]: All Service Skills
                acquired at Level 0.</p>
        </div>
        <div class="hud-footer">
            <button class="btn-action" (click)="performBasicTraining()">PROCEED_TO_TRAINING</button>
            <button class="btn-secondary" (click)="attemptCommission()"
                *ngIf="canAttemptCommission()">ATTEMPT_COMMISSION</button>
        </div>
    </div>

    <!-- STATE: SKILL_TRAINING -->
    <div *ngIf="currentState() === 'SKILL_TRAINING'" class="hud-module info fade-in">
        <div class="corner-detail tl"></div>
        <div class="corner-detail tr"></div>
        <div class="corner-detail bl"></div>
        <div class="corner-detail br"></div>
        <div class="hud-box-header">
            <span class="index">SEC_04C</span>
            <h3>{{ bonusSkillRolls() > 0 ? 'BONUS_SKILL_ACQUISITION' : 'SKILL_DEVELOPMENT_PROTOCOL' }}</h3>
        </div>
        <div class="hud-content">
            <p class="instruction">Select development vector for skill enhancement:</p>

            <div class="skill-vector-grid">
                <button class="vector-btn" (click)="rollSkill('Personal')">
                    <span class="v-label">PERSONAL_DEVELOPMENT</span>
                    <span class="v-desc">Str, Dex, End, Int...</span>
                    <div class="skill-preview">
                        <div class="skill-item" *ngFor="let s of selectedCareer?.personalSkills; let i = index">
                            <span class="num">{{i+1}}</span> {{s}}
                        </div>
                    </div>
                </button>

                <button class="vector-btn" (click)="rollSkill('Service')">
                    <span class="v-label">SERVICE_SKILLS</span>
                    <span class="v-desc">Basic training & field experience</span>
                    <div class="skill-preview">
                        <div class="skill-item" *ngFor="let s of selectedCareer?.serviceSkills; let i = index">
                            <span class="num">{{i+1}}</span> {{s}}
                        </div>
                    </div>
                </button>

                <button class="vector-btn" (click)="rollSkill('Specialist')" [disabled]="!selectedAssignment">
                    <span class="v-label">SPECIALIST_KNOWLEDGE</span>
                    <span class="v-desc">{{ selectedAssignment?.name || 'Assignments' }} Specific Skills</span>
                    <div class="skill-preview" *ngIf="selectedAssignment">
                        <div class="skill-item" *ngFor="let s of selectedAssignment.skillTable; let i = index">
                            <span class="num">{{i+1}}</span> {{s}}
                        </div>
                    </div>
                </button>

                <button class="vector-btn" (click)="rollSkill('Advanced')"
                    [disabled]="(characterService.character().characteristics.edu.value + characterService.character().characteristics.edu.modifier) < 8">
                    <span class="v-label">ADVANCED_EDUCATION</span>
                    <span class="v-desc">Requires EDU 8+</span>
                    <div class="skill-preview">
                        <div class="skill-item" *ngFor="let s of selectedCareer?.advancedEducation; let i = index">
                            <span class="num">{{i+1}}</span> {{s}}
                        </div>
                    </div>
                </button>

                <button class="vector-btn" *ngIf="selectedCareer?.officerSkills" (click)="rollSkill('Officer')"
                    [disabled]="!isCommissioned()">
                    <span class="v-label">OFFICER_TRAINING</span>
                    <span class="v-desc">Command & Management skills</span>
                    <div class="skill-preview">
                        <div class="skill-item" *ngFor="let s of selectedCareer?.officerSkills; let i = index">
                            <span class="num">{{i+1}}</span> {{s}}
                        </div>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <!-- SPECIALIZATION MODAL -->
    <div *ngIf="showSkillSelection" class="modal-overlay">
        <div class="modal">
            <div class="hud-box-header">
                <h3>SPECIALIZATION_REQUIRED: {{ pendingSkillName }}</h3>
            </div>
            <div class="grid-options">
                <button *ngFor="let opt of skillSelectionOptions" class="btn-secondary"
                    (click)="confirmSpecialization(opt)">
                    {{ opt }}
                </button>
            </div>
        </div>
    </div>

    <!-- STATE: SURVIVAL -->
    <div *ngIf="currentState() === 'SURVIVAL'" class="hud-module warning fade-in">
        <div class="corner-detail tl"></div>
        <div class="corner-detail tr"></div>
        <div class="corner-detail bl"></div>
        <div class="corner-detail br"></div>
        <div class="hud-box-header">
            <span class="index">SEC_04D</span>
            <h3>SURVIVAL_STRESS_TEST</h3>
            <span class="difficulty-badge">TRG: {{ selectedAssignment?.survivalTarget }}+</span>
        </div>

        <div class="hud-content">
            <div class="tactical-row">
                <div class="t-item">
                    <span class="t-label">PRIMARY_VECTOR</span>
                    <span class="t-val">{{ selectedAssignment?.survivalStat }}</span>
                </div>
                <div class="t-item">
                    <span class="t-label">ASSIGNMENT</span>
                    <span class="t-val">{{ selectedAssignment?.name }}</span>
                </div>
            </div>

            <p class="status-msg">[ MONITORING_VITAL_SIGNS ]: Risk assessment mandatory for term duration.</p>

            <div *ngIf="showCyberneticOption" class="hud-alert error">
                <span class="hud-label-vivid">SURVIVAL_CRITICAL_FAILURE</span>
                <p>Mishap detected. Personnel may accept Cybernetic Integration to maintain career status.</p>
                <div class="hud-footer">
                    <button class="btn-secondary" (click)="resolveSurvivalFailure(true)">ACCEPT_INTEGRATION</button>
                    <button class="btn-danger" (click)="resolveSurvivalFailure(false)">INITIATE_TERMINATION</button>
                </div>
            </div>
        </div>

        <div *ngIf="!showCyberneticOption" class="hud-footer">
            <button class="btn-action large" (click)="rollSurvival()">
                EXECUTE_SURVIVAL_ROLL
                <span class="sub-text">2D6 + {{ selectedAssignment?.survivalStat }} DM</span>
            </button>
        </div>
    </div>

    <!-- STATE: EVENT / MISHAP -->
    <div *ngIf="currentState() === 'EVENT' || currentState() === 'MISHAP'" class="hud-module fade-in"
        [class.mishap]="currentState() === 'MISHAP'">
        <div class="corner-detail tl"></div>
        <div class="corner-detail tr"></div>
        <div class="corner-detail bl"></div>
        <div class="corner-detail br"></div>
        <div class="hud-box-header">
            <span class="index">SEC_04E</span>
            <h3>{{ currentState() === 'MISHAP' ? 'CRITICAL_MISHAP_REPORT' : 'SERVICE_LIFE_EVENT' }}</h3>
        </div>
        <div class="hud-content">
            <div class="event-log-box">
                <p class="event-text">{{ currentEventText }}</p>
            </div>
        </div>

        <div class="hud-footer">
            <button *ngIf="currentState() === 'EVENT'" class="btn-action"
                (click)="currentEventText.includes('AGING') ? transitionToEndOfTerm() : proceedToAdvancement()">ACKNOWLEDGE_PROCEED</button>
            <button *ngIf="currentState() === 'MISHAP'" class="btn-danger"
                (click)="finishTerm('MUSTER')">TERMINATE_SERVICE_RECORD</button>
        </div>
    </div>

    <!-- STATE: ADVANCEMENT -->
    <div *ngIf="currentState() === 'ADVANCEMENT'" class="hud-module info fade-in">
        <div class="corner-detail tl"></div>
        <div class="corner-detail tr"></div>
        <div class="corner-detail bl"></div>
        <div class="corner-detail br"></div>
        <div class="hud-box-header">
            <span class="index">SEC_04F</span>
            <h3>ADVANCEMENT_EVALUATION</h3>
            <span class="difficulty-badge">TRG: {{ selectedAssignment?.advancementTarget }}+</span>
        </div>
        <div class="hud-content">
            <div class="tactical-row">
                <div class="t-item">
                    <span class="t-label">EVALUATION_STAT</span>
                    <span class="t-val">{{ selectedAssignment?.advancementStat }}</span>
                </div>
            </div>
            <p class="status-msg">[ PERFORMANCE_METRICS_READY ]: Evaluating promotion eligibility.</p>
        </div>

        <div class="hud-footer">
            <button class="btn-action large" (click)="rollAdvancement()">
                EXECUTE_ADVANCEMENT_ROLL
                <span class="sub-text">2D6 + {{ selectedAssignment?.advancementStat }} DM</span>
            </button>
        </div>
    </div>

    <!-- STATE: CHANGE ASSIGNMENT -->
    <div *ngIf="currentState() === 'CHANGE_ASSIGNMENT'" class="career-stack fade-in">
        <div class="hud-box-header">
            <span class="index">SEC_04G</span>
            <h3>ASSIGNMENT_RECONFIGURATION</h3>
        </div>
        <p class="status-msg" style="text-align: center;">Select new operational specialization. Qualification required.
        </p>

        <div class="career-list">
            <div *ngFor="let assign of selectedCareer?.assignments" class="career-card"
                (click)="verifyAssignmentChange(assign)">
                <div class="card-layout">
                    <div class="info-column">
                        <div class="card-header">
                            <h3>{{ assign.name }}</h3>
                        </div>
                        <div class="details">
                            <p><span class="label">QUALIFICATION:</span> <span class="highlight">{{
                                    selectedCareer?.qualificationStat }} {{ selectedCareer?.qualificationTarget
                                    }}+</span>
                            </p>
                        </div>
                    </div>
                    <div class="config-column action-centered">
                        <button class="btn-action">SELECT_ASSIGNMENT</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="hud-footer">
            <button class="btn-secondary" (click)="finishTerm('CONTINUE')">ABORT_CHANGE & STAY_CURRENT</button>
        </div>
    </div>

    <!-- Leaving Home Check -->
    <div *ngIf="currentState() === 'LEAVING_HOME'" class="hud-module fade-in">
        <div class="corner-detail tl"></div>
        <div class="corner-detail tr"></div>
        <div class="corner-detail bl"></div>
        <div class="corner-detail br"></div>
        <div class="hud-box-header">
            <span class="index">SEC_04H</span>
            <h3>HOMESTEAD_TETHR_DECOUPLING</h3>
        </div>
        <div class="hud-content">
            <p>Independence verification required. Breaking gravitational ties to hometerm.</p>
            <div class="tactical-row">
                <div class="t-item">
                    <span class="t-label">TARGET_THRESHOLD</span>
                    <span class="t-val">8+</span>
                </div>
                <div class="t-item">
                    <span class="t-label">COHESION_MODIFIER</span>
                    <span class="t-val">+{{ currentTerm() }} (Terms)</span>
                </div>
            </div>
        </div>
        <div class="hud-footer">
            <button class="btn-action" (click)="rollLeavingHome()">EXECUTE_DECOUPLING</button>
        </div>
    </div>

    <!-- Term End -->
    <div *ngIf="currentState() === 'TERM_END'" class="hud-module status fade-in">
        <div class="corner-detail tl"></div>
        <div class="corner-detail tr"></div>
        <div class="corner-detail bl"></div>
        <div class="corner-detail br"></div>
        <div class="hud-box-header">
            <span class="index">SEC_04X</span>
            <h3>SERVICE_TERM_SUMMARY [ T-{{ currentTerm() - 1 }} ]</h3>
        </div>
        <div class="hud-content">
            <div class="term-summary-mfd">
                <div class="s-card" [class.promoted]="success">
                    <span class="s-label">PROMOTION_STATUS</span>
                    <span class="s-val">{{ success ? 'PROMOTED' : 'STAGNANT' }}</span>
                </div>
                <div class="s-card" *ngIf="leavingHomeSuccess">
                    <span class="s-label">RELOCATION</span>
                    <span class="s-val">DECOUPLED</span>
                </div>
            </div>

            <div *ngIf="mandatoryContinue" class="hud-alert info">
                <span class="hud-label-vivid">MANDATORY_EXTENSION_ORDER</span>
                <p>Exceptional performance (NAT_12) triggered a non-negotiable term extension.</p>
            </div>
            <div *ngIf="forcedOut" class="hud-alert error">
                <span class="hud-label-vivid">FORCED_SEPARATION_NOTICE</span>
                <p>Operational necessity or failure results in immediate service termination.</p>
                <p *ngIf="characterService.character().history.join('').includes('Forced: Prisoner')"
                    class="highlight-vivid">SENTENCED: Transitioning to Prisoner Protocol.</p>
            </div>

            <!-- Field Mission Log -->
            <div class="mission-log-container">
                <span class="hud-label">[ FIELD_MISSION_LOG ]</span>
                <div class="mission-log-entries">
                    <div *ngFor="let note of termEventLog()" class="log-entry">
                        <span class="prefix">>></span> {{ note }}
                    </div>
                </div>
            </div>
        </div>
        <div class="hud-footer">
            <button class="btn-action" (click)="continueCareer()" [disabled]="forcedOut">START_NEXT_TERM</button>
            <button class="btn-secondary" (click)="startChangeAssignment()"
                [disabled]="mandatoryContinue || forcedOut">RECONFIG_ASSIGNMENT</button>
            <button class="btn-danger" (click)="finishTerm('MUSTER')" [disabled]="mandatoryContinue">MUSTER_OUT</button>
        </div>
    </div>

    <!-- EVENT EFFECTS MODALS -->

    <!-- 1. NPC Naming Prompt -->
    <div *ngIf="isNpcPrompt" class="modal-overlay fade-in">
        <div class="modal hud-module info">
            <div class="corner-detail tl"></div>
            <div class="corner-detail tr"></div>
            <div class="corner-detail bl"></div>
            <div class="corner-detail br"></div>
            <div class="hud-box-header">
                <span class="index">NPC_ID</span>
                <h3>RELATIONSHIP_IDENTIFICATION</h3>
            </div>
            <div class="hud-content">
                <p class="instruction">Personnel record updated with new <span class="highlight-vivid">{{ pendingNpcType.toUpperCase() }}</span> interaction.</p>
                <div class="npc-id-form">
                    <div class="p-input-group">
                        <span class="hud-label">[ ASSIGN_IDENTIFIER ]</span>
                        <input type="text" [(ngModel)]="npcNameInput" placeholder="ENTER DESIGNATION..."
                            class="cyber-input" />
                    </div>
                </div>
            </div>
            <div class="hud-footer">
                <button class="btn-action" (click)="confirmNpcGeneration()">CONFIRM_RECORD</button>
            </div>
        </div>
    </div>

    <!-- 1b. NPC Conversion Prompt (Betrayal) -->
    <div *ngIf="isNpcConversionPrompt" class="modal-overlay fade-in">
        <div class="modal hud-module warning">
            <div class="corner-detail tl"></div>
            <div class="corner-detail tr"></div>
            <div class="corner-detail bl"></div>
            <div class="corner-detail br"></div>
            <div class="hud-box-header">
                <span class="index">SEC_04B</span>
                <h3>RELATIONSHIP_ALTERATION_PROTOCOL</h3>
            </div>
            <div class="hud-content">
                <p class="hud-alert error">INTELLIGENCE_REPORT: A betrayal has been detected in your network.</p>
                <p class="instruction">SELECT AN EXISTING CONTACT TO CONVERT INTO A RIVAL/ENEMY:</p>
                <div class="npc-conversion-list">
                    <button *ngFor="let npc of characterService.character().npcs" class="npc-select-btn"
                        (click)="convertNpc(npc.id)">
                        <span class="n-name">{{ npc.name }}</span>
                        <span class="n-type">{{ npc.type }}</span>
                    </button>
                </div>
            </div>
            <div class="hud-footer">
                <button class="btn-secondary" (click)="isNpcConversionPrompt = false">ABORT_CONVERSION</button>
            </div>
        </div>
    </div>

    <!-- 1c. Neural Jack Prompt (2300AD) -->
    <div *ngIf="isNeuralJackPrompt" class="modal-overlay fade-in">
        <div class="modal hud-module info">
            <div class="hud-box-header">
                <h3>AUGMENTATION_OPPORTUNITY: NEURAL_JACK</h3>
            </div>
            <div class="hud-content">
                <p>The service offers a permanent Neural Jack interface.</p>
                <div class="hud-alert warning">
                    <p>EFFECTS: +1 Skill Roll next term.</p>
                    <p>PENALTY: -2 SOC, -2 EDU (this term).</p>
                </div>
                <div class="tactical-row">
                    <select [(ngModel)]="neuralJackCostType" class="cyber-select" title="Neural Jack Cost Type">
                        <option value="cash">Cost: 10,000 Lv</option>
                        <option value="benefit">Cost: 1 Benefit Roll</option>
                    </select>
                </div>
            </div>
            <div class="hud-footer">
                <button class="btn-action" (click)="resolveNeuralJack(true)">ACCEPT_PROCEDURE</button>
                <button class="btn-secondary" (click)="resolveNeuralJack(false)">DECLINE</button>
            </div>
        </div>
    </div>

    <!-- 2. Skill Choice Prompt -->
    <div *ngIf="isSkillChoicePrompt" class="modal-overlay fade-in">
        <div class="modal hud-module info">
            <div class="hud-box-header">
                <h3>TACTICAL_SKILL_REQUISITION</h3>
            </div>
            <div class="hud-content">
                <p class="instruction">Select one specialization from available vectors:</p>
                <div class="grid-options">
                    <button *ngFor="let skill of skillChoices" class="btn-secondary"
                        (click)="confirmSkillChoice(skill)">
                        {{ skill }}
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 3. Skill Check Outcome -->
    <div *ngIf="isSkillCheckOutcome" class="modal-overlay fade-in">
        <div class="modal hud-module status">
            <div class="hud-box-header">
                <h3>SKILL_CHECK_RESOLUTION</h3>
            </div>
            <div class="hud-content">
                <div class="event-log-box" [class.success]="skillCheckMessage.includes('Success')"
                    [class.error]="skillCheckMessage.includes('Failure')">
                    <p class="event-text outcome-message">{{ skillCheckMessage }}</p>
                </div>
            </div>
            <div class="hud-footer">
                <button class="btn-action" (click)="isSkillCheckOutcome = false">ACKNOWLEDGE</button>
            </div>
        </div>
    </div>

    <!-- 4. Connections Rule Prompt -->
    <div *ngIf="isConnectionsRuleEligible" class="modal-overlay fade-in">
        <div class="modal hud-module warning">
            <div class="hud-box-header">
                <h3>CONNECTIONS_RULE_OPPORTUNITY</h3>
            </div>
            <div class="hud-content">
                <p>Establishing a relationship allows you to improve a shared skill. (Used {{
                    characterService.character().connectionsUsed }}/2)</p>
                <p class="instruction" *ngIf="connectionsSkillChoices.length > 0">Select skill to increase by +1:</p>
                <div class="grid-options" *ngIf="connectionsSkillChoices.length > 0">
                    <button *ngFor="let skill of connectionsSkillChoices" class="btn-secondary"
                        (click)="applyConnectionsRule(skill)">
                        {{ skill }}
                    </button>
                </div>
                <p *ngIf="connectionsSkillChoices.length === 0" class="hud-alert error">No compatible skills at level 1+
                    to improve.</p>
            </div>
            <div class="hud-footer">
                <button class="btn-secondary" (click)="skipConnectionsRule()">SKIP_OPPORTUNITY</button>
            </div>
        </div>
    </div>

    <!-- 5. Life Event Choice Modal -->
    <div *ngIf="isLifeEventChoice" class="modal-overlay fade-in">
        <div class="modal hud-module info">
            <div class="hud-box-header">
                <h3>LIFE_ALTERING_DECISION</h3>
            </div>
            <div class="hud-content">
                <p class="instruction">{{ lifeEventChoiceNote }}</p>
                <div class="choice-grid">
                    <div *ngFor="let opt of lifeEventChoiceOptions" class="choice-item">
                        <button class="btn-action full-width"
                            (click)="$event.stopPropagation(); handleLifeEventChoice(opt)">
                            {{ opt.toUpperCase().replace(' ', '_') }}
                        </button>
                        <p class="choice-outcome">{{ getChoiceDescription(opt) }}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 6. Injury Selection Modal -->
    <div *ngIf="isInjuryPrompt" class="modal-overlay fade-in">
        <div class="modal hud-module warning">
            <div class="hud-box-header">
                <h3>INJURY_SEVERITY_REPORT</h3>
            </div>
            <div class="hud-content">
                <p class="hud-alert error">SEVERITY: {{ injurySeverity }}</p>
                <p class="instruction">Select attribute for primary degradation ({{ injuryMajorLoss }} pts):</p>
                <div class="grid-options">
                    <button *ngFor="let stat of pendingInjuryStats" class="btn-secondary"
                        (click)="selectInjuryStat(stat)">
                        {{ stat }}
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 7. Medical Treatment Decision Modal -->
    <div *ngIf="isInjuryDecisionActive" class="modal-overlay fade-in">
        <div class="modal hud-module status">
            <div class="hud-box-header">
                <h3>TREATMENT_PROTOCOL_SELECTION</h3>
            </div>
            <div class="hud-content">
                <div class="tactical-row">
                    <div class="t-item">
                        <span class="t-label">COVERAGE</span>
                        <span class="t-val">{{ medicalCoverage * 100 }}%</span>
                    </div>
                    <div class="t-item">
                        <span class="t-label">TOTAL_COST</span>
                        <span class="t-val">{{ medicalRestorationCost }} Lv</span>
                    </div>
                </div>
                <div class="hud-alert info">
                    <p>Option A: Cyber-Augment. Cost: 1 Benefit Roll Debt. No stat loss.</p>
                    <p>Option B: Standard Care. Cost: {{ medicalDebtCalculated }} Lv Debt. Permanent Stat Loss.</p>
                </div>
            </div>
            <div class="hud-footer">
                <button class="btn-action" (click)="resolveInjury(true)">ACCEPT_AUGMENTATION (Option A)</button>
                <button class="btn-secondary" (click)="resolveInjury(false)">CONFIRM_STANDARD_CARE (Option B)</button>
            </div>
        </div>
    </div>

    <!-- 9. Stat Reduction Modal (Prisoner) -->
    <div *ngIf="isStatReductionChoice" class="modal-overlay fade-in">
        <div class="modal hud-module warning">
            <div class="hud-box-header">
                <h3>CHARACTERISTIC_DEGRADATION_CHOICE</h3>
            </div>
            <div class="hud-content">
                <p class="instruction">Select one characteristic to reduce by {{ 1 }}:</p>
                <div class="grid-options">
                    <button *ngFor="let stat of ['STR', 'DEX', 'END', 'INT', 'EDU', 'SOC']" class="btn-secondary"
                        (click)="selectStatReduction(stat)">
                        {{ stat }}
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 10. Gambling Choice Modal (Merchant) -->
    <div *ngIf="isGamblingPrompt" class="modal-overlay fade-in">
        <div class="modal hud-module info">
            <div class="hud-box-header">
                <h3>GAMBLING_PROTOCOL_AVAILABLE</h3>
            </div>
            <div class="hud-content">
                <p>You may bet up to {{ benefitRollsToBet }} benefit rolls to increase rewards (risk of losing all
                    benefits this term).</p>
                <div class="grid-options">
                    <button class="btn-secondary" (click)="resolveGambling(0)">DECLINE_GAMBLING</button>
                    <button *ngFor="let num of [1, 2, 3]" class="btn-action" [hidden]="num > benefitRollsToBet"
                        (click)="resolveGambling(num)">
                        BET_{{ num }}_ROLLS
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 8. Existing NPC Selection (for npc-note) -->
    <div *ngIf="isNpcPrompt && characterService.character().npcs.length > 0 && pendingNpcType === 'rival'"
        class="modal-overlay fade-in">
        <div class="modal hud-module warning">
            <div class="hud-box-header">
                <h3>SELECT_TARGET_NPC</h3>
            </div>
            <div class="hud-content">
                <p>An existing NPC has crossed paths with you: <span class="highlight">{{ pendingNpcOrigin }}</span></p>
                <div class="grid-options">
                    <button *ngFor="let npc of characterService.character().npcs" class="btn-secondary"
                        (click)="confirmNpcGeneration(npc.name)">
                        {{ npc.name }} ({{ npc.type }})
                    </button>
                    <button class="btn-danger" (click)="applyEventEffect({type: 'injury'})">NONE_AVAILABLE (Suffer
                        Injury)</button>
                </div>
            </div>
        </div>
    </div>
</div>