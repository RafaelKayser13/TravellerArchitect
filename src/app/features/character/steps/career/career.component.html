<div class="career-container">
    <app-step-header 
        stepSymbol="SEC" 
        stepNumber="06" 
        superLabel="SERVICE_HISTORY_PROTOCOL"
        topLabel="CHRONOS_STATUS"
        title="CAREER_SERVICE_RECORDS" 
        subtitle="Term {{ currentTerm() }} (Age {{ currentAge() }})">
    </app-step-header>

    <!-- 1. CHOOSE CAREER -->
    <div *ngIf="currentState() === 'CHOOSE_CAREER'" class="career-stack fade-in">
        <div class="hud-box-header">
            <span class="index">SEC_04</span>
            <h3>CAREER_SELECTION_PROTOCOL</h3>
        </div>

        <div class="career-list">
            <div *ngFor="let career of careers; let i = index" class="career-card"
                [class.selected]="selectedCareer === career" (click)="selectCareer(career)">

                <div class="card-layout">
                    <!-- Info Column -->
                    <div class="info-column">
                        <div class="card-header">
                            <span class="index">0{{i+1}}</span>
                            <h3>{{ career.name }}</h3>
                        </div>
                        <div class="details">
                            <p><span class="label">QUALIFICATION:</span> <span class="highlight">{{
                                    career.qualificationStat
                                    }} {{ career.qualificationTarget }}+</span></p>
                            <div class="description-text">{{ career.description }}</div>
                        </div>
                    </div>

                    <!-- Config Column (Active only when selected) -->
                    <div class="config-column" *ngIf="selectedCareer === career" (click)="$event.stopPropagation()">
                        <div class="assignment-selector">
                            <span class="hud-label">[ SELECT_ASSIGNMENT_SPECIALIZATION ]</span>
                            <div class="radio-tab-group">
                                <label class="radio-tab" *ngFor="let assign of career.assignments">
                                    <input type="radio" name="assignment" [value]="assign"
                                        [checked]="selectedAssignment === assign" (change)="selectAssignment(assign)" />
                                    <div class="tab-content">
                                        <span class="primary">{{ assign.name }}</span>
                                        <span class="secondary">SRV: {{ assign.survivalStat }} {{ assign.survivalTarget
                                            }}+</span>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <div class="card-footer-actions">
                            <button class="btn-action" [disabled]="!selectedAssignment" (click)="qualify()">
                                ATTEMPT_QUALIFICATION
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Career Finalization / Global Actions -->
        <div class="global-actions" *ngIf="characterService.character().careerHistory.length > 0">
            <div class="divider"></div>
            <button class="btn-action finalize" (click)="startMusteringOut()">
                FINALIZE_SERVICE_RECORD & MUSTER_OUT
            </button>
        </div>
    </div>

    <!-- STATE: BASIC_TRAINING -->
    <div *ngIf="currentState() === 'BASIC_TRAINING'" class="hud-module success fade-in">
        <div class="corner-detail tl"></div>
        <div class="corner-detail tr"></div>
        <div class="corner-detail bl"></div>
        <div class="corner-detail br"></div>
        <div class="hud-box-header">
            <span class="index">SEC_04B</span>
            <h3>BASIC_TRAINING_PROTOCOL</h3>
        </div>
        <div class="hud-content">
            <p>Personnel has successfully matriculated into the <span class="highlight">{{ selectedCareer?.name
                    }}</span>.
            </p>
            <p *ngIf="currentTerm() === 1" class="status-msg">[ INITIAL_QUALIFICATION_RECOGNIZED ]: All Service Skills
                acquired at Level 0.</p>
        </div>
        <div class="hud-footer">
            <button class="btn-action" (click)="performBasicTraining()">PROCEED_TO_TRAINING</button>
            <button class="btn-secondary" (click)="attemptCommission()"
                *ngIf="canAttemptCommission()">ATTEMPT_COMMISSION</button>
        </div>
    </div>

    <!-- STATE: SKILL_TRAINING -->
    <div *ngIf="currentState() === 'SKILL_TRAINING'" class="hud-module info fade-in">
        <div class="corner-detail tl"></div>
        <div class="corner-detail tr"></div>
        <div class="corner-detail bl"></div>
        <div class="corner-detail br"></div>
        <div class="hud-box-header">
            <span class="index">SEC_04C</span>
            <h3>{{ bonusSkillRolls() > 0 ? 'BONUS_SKILL_ACQUISITION' : 'SKILL_DEVELOPMENT_PROTOCOL' }}</h3>
        </div>
        <div class="hud-content">
            <p class="instruction">Select development vector for skill enhancement:</p>

            <div class="skill-vector-grid">
                <button class="vector-btn" (click)="rollSkill('Personal')">
                    <span class="v-label">PERSONAL_DEVELOPMENT</span>
                    <span class="v-desc">Str, Dex, End, Int...</span>
                    <div class="skill-preview">
                        <div class="skill-item" *ngFor="let s of selectedCareer?.personalSkills; let i = index">
                            <span class="num">{{i+1}}</span> {{s}}
                        </div>
                    </div>
                </button>

                <button class="vector-btn" (click)="rollSkill('Service')">
                    <span class="v-label">SERVICE_SKILLS</span>
                    <span class="v-desc">Basic training & field experience</span>
                    <div class="skill-preview">
                        <div class="skill-item" *ngFor="let s of selectedCareer?.serviceSkills; let i = index">
                            <span class="num">{{i+1}}</span> {{s}}
                        </div>
                    </div>
                </button>

                <button class="vector-btn" (click)="rollSkill('Specialist')" [disabled]="!selectedAssignment">
                    <span class="v-label">SPECIALIST_KNOWLEDGE</span>
                    <span class="v-desc">{{ selectedAssignment?.name || 'Assignments' }} Specific Skills</span>
                    <div class="skill-preview" *ngIf="selectedAssignment">
                        <div class="skill-item" *ngFor="let s of selectedAssignment.skillTable; let i = index">
                            <span class="num">{{i+1}}</span> {{s}}
                        </div>
                    </div>
                </button>

                <button class="vector-btn" (click)="rollSkill('Advanced')"
                    [disabled]="(characterService.character().characteristics.edu.value + characterService.character().characteristics.edu.modifier) < 8">
                    <span class="v-label">ADVANCED_EDUCATION</span>
                    <span class="v-desc">Requires EDU 8+</span>
                    <div class="skill-preview">
                        <div class="skill-item" *ngFor="let s of selectedCareer?.advancedEducation; let i = index">
                            <span class="num">{{i+1}}</span> {{s}}
                        </div>
                    </div>
                </button>

                <button class="vector-btn" *ngIf="selectedCareer?.officerSkills" (click)="rollSkill('Officer')"
                    [disabled]="getRank() <= 0">
                    <span class="v-label">OFFICER_TRAINING</span>
                    <span class="v-desc">Command & Management skills</span>
                    <div class="skill-preview">
                        <div class="skill-item" *ngFor="let s of selectedCareer?.officerSkills; let i = index">
                            <span class="num">{{i+1}}</span> {{s}}
                        </div>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <!-- SPECIALIZATION MODAL -->
    <div *ngIf="showSkillSelection" class="modal-overlay">
        <div class="modal">
            <div class="hud-box-header">
                <h3>SPECIALIZATION_REQUIRED: {{ pendingSkillName }}</h3>
            </div>
            <div class="grid-options">
                <button *ngFor="let opt of skillSelectionOptions" class="btn-secondary"
                    (click)="confirmSpecialization(opt)">
                    {{ opt }}
                </button>
            </div>
        </div>
    </div>

    <!-- STATE: SURVIVAL -->
    <div *ngIf="currentState() === 'SURVIVAL'" class="hud-module warning fade-in">
        <div class="corner-detail tl"></div>
        <div class="corner-detail tr"></div>
        <div class="corner-detail bl"></div>
        <div class="corner-detail br"></div>
        <div class="hud-box-header">
            <span class="index">SEC_04D</span>
            <h3>SURVIVAL_STRESS_TEST</h3>
            <span class="difficulty-badge">TRG: {{ selectedAssignment?.survivalTarget }}+</span>
        </div>

        <div class="hud-content">
            <div class="tactical-row">
                <div class="t-item">
                    <span class="t-label">PRIMARY_VECTOR</span>
                    <span class="t-val">{{ selectedAssignment?.survivalStat }}</span>
                </div>
                <div class="t-item">
                    <span class="t-label">ASSIGNMENT</span>
                    <span class="t-val">{{ selectedAssignment?.name }}</span>
                </div>
            </div>

            <p class="status-msg">[ MONITORING_VITAL_SIGNS ]: Risk assessment mandatory for term duration.</p>

            <div *ngIf="showCyberneticOption" class="hud-alert error">
                <span class="hud-label-vivid">SURVIVAL_CRITICAL_FAILURE</span>
                <p>Mishap detected. Personnel may accept Cybernetic Integration to maintain career status.</p>
                <div class="hud-footer">
                    <button class="btn-secondary" (click)="resolveSurvivalFailure(true)">ACCEPT_INTEGRATION</button>
                    <button class="btn-danger" (click)="resolveSurvivalFailure(false)">INITIATE_TERMINATION</button>
                </div>
            </div>
        </div>

        <div *ngIf="!showCyberneticOption" class="hud-footer">
            <button class="btn-action large" (click)="rollSurvival()">
                EXECUTE_SURVIVAL_ROLL
                <span class="sub-text">2D6 + {{ selectedAssignment?.survivalStat }} DM</span>
            </button>
        </div>
    </div>

    <!-- STATE: EVENT / MISHAP -->
    <div *ngIf="currentState() === 'EVENT' || currentState() === 'MISHAP'" class="hud-module fade-in"
        [class.mishap]="currentState() === 'MISHAP'">
        <div class="corner-detail tl"></div>
        <div class="corner-detail tr"></div>
        <div class="corner-detail bl"></div>
        <div class="corner-detail br"></div>
        <div class="hud-box-header">
            <span class="index">SEC_04E</span>
            <h3>{{ currentState() === 'MISHAP' ? 'CRITICAL_MISHAP_REPORT' : 'SERVICE_LIFE_EVENT' }}</h3>
        </div>
        <div class="hud-content">
            <div class="event-log-box">
                <p class="event-text">{{ currentEventText }}</p>
            </div>
        </div>

        <div class="hud-footer">
            <button *ngIf="currentState() === 'EVENT'" class="btn-action"
                (click)="proceedToAdvancement()">ACKNOWLEDGE_PROCEED</button>
            <button *ngIf="currentState() === 'MISHAP'" class="btn-danger"
                (click)="finishTerm('MUSTER')">TERMINATE_SERVICE_RECORD</button>
        </div>
    </div>

    <!-- STATE: ADVANCEMENT -->
    <div *ngIf="currentState() === 'ADVANCEMENT'" class="hud-module info fade-in">
        <div class="corner-detail tl"></div>
        <div class="corner-detail tr"></div>
        <div class="corner-detail bl"></div>
        <div class="corner-detail br"></div>
        <div class="hud-box-header">
            <span class="index">SEC_04F</span>
            <h3>ADVANCEMENT_EVALUATION</h3>
            <span class="difficulty-badge">TRG: {{ selectedAssignment?.advancementTarget }}+</span>
        </div>
        <div class="hud-content">
            <div class="tactical-row">
                <div class="t-item">
                    <span class="t-label">EVALUATION_STAT</span>
                    <span class="t-val">{{ selectedAssignment?.advancementStat }}</span>
                </div>
            </div>
            <p class="status-msg">[ PERFORMANCE_METRICS_READY ]: Evaluating promotion eligibility.</p>
        </div>

        <div class="hud-footer">
            <button class="btn-action large" (click)="rollAdvancement()">
                EXECUTE_ADVANCEMENT_ROLL
                <span class="sub-text">2D6 + {{ selectedAssignment?.advancementStat }} DM</span>
            </button>
        </div>
    </div>

    <!-- STATE: CHANGE ASSIGNMENT -->
    <div *ngIf="currentState() === 'CHANGE_ASSIGNMENT'" class="career-stack fade-in">
        <div class="hud-box-header">
            <span class="index">SEC_04G</span>
            <h3>ASSIGNMENT_RECONFIGURATION</h3>
        </div>
        <p class="status-msg" style="text-align: center;">Select new operational specialization. Qualification required.
        </p>

        <div class="career-list">
            <div *ngFor="let assign of selectedCareer?.assignments" class="career-card"
                (click)="verifyAssignmentChange(assign)">
                <div class="card-layout">
                    <div class="info-column">
                        <div class="card-header">
                            <h3>{{ assign.name }}</h3>
                        </div>
                        <div class="details">
                            <p><span class="label">QUALIFICATION:</span> <span class="highlight">{{
                                    selectedCareer?.qualificationStat }} {{ selectedCareer?.qualificationTarget
                                    }}+</span>
                            </p>
                        </div>
                    </div>
                    <div class="config-column action-centered">
                        <button class="btn-action">SELECT_ASSIGNMENT</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="hud-footer">
            <button class="btn-secondary" (click)="finishTerm('CONTINUE')">ABORT_CHANGE & STAY_CURRENT</button>
        </div>
    </div>

    <!-- Leaving Home Check -->
    <div *ngIf="currentState() === 'LEAVING_HOME'" class="hud-module fade-in">
        <div class="corner-detail tl"></div>
        <div class="corner-detail tr"></div>
        <div class="corner-detail bl"></div>
        <div class="corner-detail br"></div>
        <div class="hud-box-header">
            <span class="index">SEC_04H</span>
            <h3>HOMESTEAD_TETHR_DECOUPLING</h3>
        </div>
        <div class="hud-content">
            <p>Independence verification required. Breaking gravitational ties to hometerm.</p>
            <div class="tactical-row">
                <div class="t-item">
                    <span class="t-label">TARGET_THRESHOLD</span>
                    <span class="t-val">8+</span>
                </div>
                <div class="t-item">
                    <span class="t-label">COHESION_MODIFIER</span>
                    <span class="t-val">+{{ currentTerm() }} (Terms)</span>
                </div>
            </div>
        </div>
        <div class="hud-footer">
            <button class="btn-action" (click)="rollLeavingHome()">EXECUTE_DECOUPLING</button>
        </div>
    </div>

    <!-- Term End -->
    <div *ngIf="currentState() === 'TERM_END'" class="hud-module status fade-in">
        <div class="corner-detail tl"></div>
        <div class="corner-detail tr"></div>
        <div class="corner-detail bl"></div>
        <div class="corner-detail br"></div>
        <div class="hud-box-header">
            <span class="index">SEC_04X</span>
            <h3>SERVICE_TERM_SUMMARY [ T-{{ currentTerm() - 1 }} ]</h3>
        </div>
        <div class="hud-content">
            <div class="term-summary-mfd">
                <div class="s-card" [class.promoted]="success">
                    <span class="s-label">PROMOTION_STATUS</span>
                    <span class="s-val">{{ success ? 'PROMOTED' : 'STAGNANT' }}</span>
                </div>
                <div class="s-card" *ngIf="leavingHomeSuccess">
                    <span class="s-label">RELOCATION</span>
                    <span class="s-val">DECOUPLED</span>
                </div>
            </div>

            <div *ngIf="mandatoryContinue" class="hud-alert info">
                <span class="hud-label-vivid">MANDATORY_EXTENSION_ORDER</span>
                <p>Exceptional performance (NAT_12) triggered a non-negotiable term extension.</p>
            </div>
            <div *ngIf="forcedOut" class="hud-alert error">
                <span class="hud-label-vivid">FORCED_SEPARATION_NOTICE</span>
                <p>Operational necessity or failure results in immediate service termination.</p>
            </div>
        </div>
        <div class="hud-footer">
            <button class="btn-action" (click)="continueCareer()" [disabled]="forcedOut">START_NEXT_TERM</button>
            <button class="btn-secondary" (click)="startChangeAssignment()"
                [disabled]="mandatoryContinue || forcedOut">RECONFIG_ASSIGNMENT</button>
            <button class="btn-danger" (click)="finishTerm('MUSTER')" [disabled]="mandatoryContinue">MUSTER_OUT</button>
        </div>
    </div>
</div>