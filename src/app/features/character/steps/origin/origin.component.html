<div class="origin-container">
    <app-step-header 
        stepSymbol="SEC" 
        stepNumber="04" 
        superLabel="PLANETARY_DATABASE_HUB"
        topLabel="GEOGRAPHIC_ORIGIN"
        title="NATIONALITY_ESTABLISHMENT" 
        subtitle="ENFORCING_SOCIO-POLITICAL_TERRITORIAL_DATA... [ OK ]">
    </app-step-header>
    <section>
        <div class="section-header">
            <span class="sh-idx">01</span>
            <h2 class="sh-title">NATIONALITY_SELECTION</h2>
        </div>
        <div class="data-roster">
            <div class="dr-thead">
                <span class="drh-id">ID</span>
                <span class="drh-name">NATION_DESIGNATION</span>
                <span class="drh-col">CLASS</span>
                <span class="drh-status">STATUS</span>
            </div>
            <div class="dr-row" *ngFor="let nat of nationalities; let i = index"
                [class.dr-sel]="selectedNationality?.name === nat.name"
                [class.dr-lock]="!isNationalityAvailable(nat)"
                (click)="isNationalityAvailable(nat) && selectNationality(nat)">
                <div class="dr-strip">
                    <span class="dr-id">{{ (i+1) | number:'2.0-0' }}</span>
                    <span class="dr-led" [class.led-on]="selectedNationality?.name === nat.name" [class.led-lock]="!isNationalityAvailable(nat)"></span>
                    <span class="dr-name">{{ nat.name }}</span>
                    <span class="dr-col">{{ nat.tier === 1 ? 'SUPERPOWER' : 'TIER_' + nat.tier }}</span>
                    <span class="dr-status" [class.st-sel]="selectedNationality?.name === nat.name" [class.st-lock]="!isNationalityAvailable(nat)">
                        {{ !isNationalityAvailable(nat) ? 'RESTRICTED' : (selectedNationality?.name === nat.name ? 'SELECTED' : 'AVAILABLE') }}
                    </span>
                    <span class="dr-chev" [class.open]="selectedNationality?.name === nat.name">&#9656;</span>
                </div>
                <div class="dr-expand" *ngIf="selectedNationality?.name === nat.name">
                    <p class="expand-desc">{{ nat.description }}</p>
                    <div *ngIf="!isNationalityAvailable(nat)" class="expand-warning">
                        <span>âš </span> {{ getIncompatibilityReason('Nationality', nat) }}
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section *ngIf="selectedNationality" class="origin-type-section" #originTypeSection>
        <h2 class="step-title">Origin Type</h2>
        <div class="origin-types">
            <div class="type-card" [class.selected]="selectedOriginType === 'Core'" 
                [class.disabled]="!isOriginTypeAvailable('Core')"
                (click)="isOriginTypeAvailable('Core') && setOriginType('Core')">
                <h3>Core</h3>
                <p>Earth & Tirane</p>
                <div class="restriction-info" *ngIf="!isOriginTypeAvailable('Core')">
                    {{ getIncompatibilityReason('OriginType', 'Core') }}
                </div>
            </div>
            <div class="type-card" [class.selected]="selectedOriginType === 'Frontier'"
                [class.disabled]="!isOriginTypeAvailable('Frontier')"
                (click)="isOriginTypeAvailable('Frontier') && setOriginType('Frontier')">
                <h3>Frontier</h3>
                <p>Colonial Worlds</p>
                <div class="restriction-info" *ngIf="!isOriginTypeAvailable('Frontier')">
                    {{ getIncompatibilityReason('OriginType', 'Frontier') }}
                </div>
            </div>
            <div class="type-card" [class.selected]="selectedOriginType === 'Spacer'" 
                [class.disabled]="!isOriginTypeAvailable('Spacer')"
                (click)="isOriginTypeAvailable('Spacer') && setOriginType('Spacer')">
                <h3>Spacer</h3>
                <p>Stations & Belts</p>
                <div class="restriction-info" *ngIf="!isOriginTypeAvailable('Spacer')">
                    {{ getIncompatibilityReason('OriginType', 'Spacer') }}
                </div>
            </div>
        </div>
    </section>

    <section *ngIf="selectedNationality && availableWorlds.length > 0" class="homeworld-section" #homeworldSection>
        <div class="section-header">
            <span class="sh-idx">03</span>
            <h2 class="sh-title">HOMEWORLD_SELECTION</h2>
        </div>
        <div class="data-roster">
            <div class="dr-thead">
                <span class="drh-id">ID</span>
                <span class="drh-name">WORLD</span>
                <span class="drh-col">GRAVITY</span>
                <span class="drh-col">SRV_DM</span>
                <span class="drh-status">STATUS</span>
            </div>
            <div class="dr-row" *ngFor="let world of availableWorlds; let i = index"
                [class.dr-sel]="selectedWorld?.name === world.name"
                (click)="selectWorld(world)">
                <div class="dr-strip">
                    <span class="dr-id">{{ (i+1) | number:'2.0-0' }}</span>
                    <span class="dr-led" [class.led-on]="selectedWorld?.name === world.name"></span>
                    <span class="dr-name">{{ world.name }}</span>
                    <span class="dr-col" [class.dr-danger]="world.gravityCode === 'High' || world.gravityCode === 'Extreme'" [class.dr-dim]="world.gravityCode === 'Low'">
                        {{ world.gravity }}G &middot; {{ world.gravityCode | uppercase }}
                    </span>
                    <span class="dr-col" [class.dr-pos]="world.survivalDm > 0" [class.dr-neg]="world.survivalDm < 0">
                        {{ world.survivalDm >= 0 ? '+' : '' }}{{ world.survivalDm }}
                    </span>
                    <span class="dr-status" [class.st-sel]="selectedWorld?.name === world.name">
                        {{ selectedWorld?.name === world.name ? 'SELECTED' : 'AVAILABLE' }}
                    </span>
                    <span class="dr-chev" [class.open]="selectedWorld?.name === world.name">&#9656;</span>
                </div>
                <div class="dr-expand world-expand" *ngIf="selectedWorld?.name === world.name">
                    <div class="we-tags">
                        <span class="we-tag">{{ world.system }}</span>
                        <span class="we-tag" [class.tag-warn]="world.gravityCode === 'High' || world.gravityCode === 'Extreme'">{{ world.gravity }}G</span>
                        <span class="we-tag">{{ world.path || 'Soft' }} PATH</span>
                        <span class="we-tag tag-cyan" *ngIf="world.techLevel">TL {{ world.techLevel }}</span>
                    </div>
                    <p class="we-warning" *ngIf="world.gravityCode === 'High' || world.gravityCode === 'Extreme'">âš  HIGH_GRAVITY_ENVIRONMENT DETECTED</p>
                    <p class="we-info" *ngIf="world.gravityCode === 'Low'">&gt;&gt; LOW_G_ENVIRONMENT</p>
                </div>
            </div>
        </div>
    </section>

    <section *ngIf="selectedWorld" class="philosophy-section">
        <div class="section-header">
            <span class="sh-idx">04</span>
            <h2 class="sh-title">COLONIAL_PHILOSOPHY</h2>
        </div>
        <div class="choice-chips">
            <div class="choice-chip" [class.chip-sel]="selectedPath === 'Hard'" (click)="setPath('Hard')">
                <span class="cc-led" [class.on]="selectedPath === 'Hard'"></span>
                <div class="cc-body">
                    <span class="cc-name">HARD_PATH</span>
                    <span class="cc-desc">Technological adaptation â€” Machinery and habitats. DM: +1 benefit</span>
                </div>
            </div>
            <div class="choice-chip" [class.chip-sel]="selectedPath === 'Soft'" (click)="setPath('Soft')">
                <span class="cc-led" [class.on]="selectedPath === 'Soft'"></span>
                <div class="cc-body">
                    <span class="cc-name">SOFT_PATH</span>
                    <span class="cc-desc">Biological adaptation â€” DNA mods and symbionts. DM: -1 benefit</span>
                </div>
            </div>
        </div>
    </section>

    <section *ngIf="selectedWorld && showSkillsSelection" class="skills-section" #skillsSection>
        <div class="section-header">
            <span class="sh-idx">05</span>
            <h2 class="sh-title">BACKGROUND_SKILLS</h2>
            <span class="sh-badge">{{ selectedBackgroundSkills.length }}/{{ backgroundSkillsCount }}</span>
        </div>
        <p class="instruction">SELECT {{ backgroundSkillsCount }} BACKGROUND SKILL VECTORS FROM ORIGIN DATA</p>

        <div class="skills-grid">
            <div class="skill-chip" *ngFor="let skill of availableSkills"
                [class.selected]="selectedBackgroundSkills.includes(skill)"
                [class.disabled]="!selectedBackgroundSkills.includes(skill) && selectedBackgroundSkills.length >= backgroundSkillsCount"
                (click)="toggleSkill(skill)">
                {{ skill }}
            </div>
        </div>

        <div class="mod-summary" *ngIf="selectedWorld">
            <h3>BIO_REPORT</h3>
            <p *ngIf="selectedOriginType === 'Spacer'">SPACER: Zero-G Adaptation applied (Vacc Suit enabled).</p>
            <p *ngIf="selectedWorld.name.includes('King') || selectedWorld.name.includes('Huntsland') || selectedWorld.name.includes('New Columbia')">HEAVY_WORLDER: Genetic STR/END
                modification detected.</p>
        </div>

    </section>

    <section class="species-adaptation-report">
        <div class="adaptation-banner">
            <div class="banner-header">
                <span class="scanline"></span>
                <span class="hud-icon">ðŸ§¬</span>
                <span class="title">BIOLOGICAL_CONSISTENCY_CHECK</span>
            </div>
            <div class="banner-content">
                <div class="species-info">
                    <span class="label">CURRENT_SPECIES:</span>
                    <span class="value">{{ characterService.character().species }}</span>
                </div>
                <div class="restriction-list">
                    <div class="restriction-item" *ngIf="characterService.character().species === 'Human (Spacer)'">
                        <span class="bullet">>></span> RESTRICTED_TO_ORBITAL_ENVIRONMENTS (ZERO-G_ADAPTATION_ACTIVE)
                    </div>
                    <div class="restriction-item" *ngIf="characterService.character().species === 'Human (Heavy-Worlder)'">
                        <span class="bullet">>></span> RESTRICTED_TO_HIGH-G_COLONIES (USA, AUSTRALIA, MANCHURIA...)
                    </div>
                    <div class="restriction-item" *ngIf="['Human (Cold-Adapted)', 'Human (Dry-Worlder)'].includes(characterService.character().species)">
                        <span class="bullet">>></span> COLONIAL_ENVIRONMENTAL_REQUIREMENTS_ENFORCED
                    </div>
                    <div class="restriction-item success" *ngIf="characterService.character().species === 'Human (Standard)'">
                        <span class="bullet">>></span> NO_BIOLOGICAL_RESTRICTIONS_DETECTED
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Japanese Nationality Choice -->
    <div class="modal-overlay" *ngIf="isJapanBonusPrompt">
        <div class="modal-card">
            <h3>NATIONALITY_REWARD_DETECTION</h3>
            <p>Japanese personnel are eligible for specialized training or social standing elevation via the Officer Corps.</p>
            <div class="choice-buttons">
                <button (click)="selectJapanBonus('EDU')">CORE_EDUCATION (+1 EDU)</button>
                <button (click)="selectJapanBonus('Rank')">OFFICER_RECRUITMENT (+1 RANK)</button>
            </div>
        </div>
    </div>
</div>