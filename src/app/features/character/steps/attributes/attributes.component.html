<div class="attributes-layout">
    <app-step-header 
        stepSymbol="SEC" 
        stepNumber="03" 
        superLabel="CHARACTER_BIOMETRICS_V2.0"
        topLabel="ATTRIBUTE_READOUT"
        title="BIOMETRIC_SEQUENCING" 
        subtitle="INITIALIZING_CHARACTER_DATA_OUTPUT... [ STANDBY ]">
    </app-step-header>

    <div class="hex-arena">
        <div class="hex-bg-pattern" aria-hidden="true"></div>

        <div class="hex-grid">

            <!-- ─── Circuit trace SVG overlay ─────────────────────── -->
            <svg class="circuit-svg" viewBox="0 0 648 292"
                 xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                <defs>
                    <filter id="cglow" x="-80%" y="-80%" width="260%" height="260%">
                        <feGaussianBlur stdDeviation="5" result="b"/>
                        <feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge>
                    </filter>
                    <filter id="cled" x="-80%" y="-80%" width="260%" height="260%">
                        <feGaussianBlur stdDeviation="3" result="b"/>
                        <feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge>
                    </filter>
                </defs>

                <!-- Glow backdrop (thick blurred lines) -->
                <g stroke="rgba(0,140,220,0.15)" stroke-width="10" fill="none" filter="url(#cglow)">
                    <line x1="74"  y1="64"  x2="274" y2="64"/>
                    <line x1="274" y1="64"  x2="474" y2="64"/>
                    <line x1="174" y1="228" x2="374" y2="228"/>
                    <line x1="374" y1="228" x2="574" y2="228"/>
                    <line x1="74"  y1="64"  x2="174" y2="228"/>
                    <line x1="274" y1="64"  x2="174" y2="228"/>
                    <line x1="274" y1="64"  x2="374" y2="228"/>
                    <line x1="474" y1="64"  x2="374" y2="228"/>
                    <line x1="474" y1="64"  x2="574" y2="228"/>
                </g>

                <!-- Main circuit lines -->
                <g class="circuit-main" stroke="rgba(0,210,255,0.45)" stroke-width="1.5" fill="none">
                    <line x1="74"  y1="64"  x2="274" y2="64"/>
                    <line x1="274" y1="64"  x2="474" y2="64"/>
                    <line x1="174" y1="228" x2="374" y2="228"/>
                    <line x1="374" y1="228" x2="574" y2="228"/>
                    <line x1="74"  y1="64"  x2="174" y2="228"/>
                    <line x1="274" y1="64"  x2="174" y2="228"/>
                    <line x1="274" y1="64"  x2="374" y2="228"/>
                    <line x1="474" y1="64"  x2="374" y2="228"/>
                    <line x1="474" y1="64"  x2="574" y2="228"/>
                </g>

                <!-- Flow animation layer (dashed, moves along traces) -->
                <g class="circuit-flow" stroke="rgba(0,240,255,0.7)" stroke-width="1.5" fill="none">
                    <line x1="74"  y1="64"  x2="274" y2="64"/>
                    <line x1="274" y1="64"  x2="474" y2="64"/>
                    <line x1="174" y1="228" x2="374" y2="228"/>
                    <line x1="374" y1="228" x2="574" y2="228"/>
                </g>

                <!-- Perpendicular branch stubs off horizontal traces -->
                <g stroke="rgba(0,190,255,0.3)" stroke-width="1" fill="none">
                    <!-- STR-DEX gap x=148..200 y=64 -->
                    <line x1="157" y1="56" x2="157" y2="64"/>
                    <line x1="157" y1="64" x2="148" y2="64"/>
                    <line x1="191" y1="64" x2="191" y2="72"/>
                    <line x1="191" y1="64" x2="200" y2="64"/>
                    <!-- DEX-END gap x=348..400 y=64 -->
                    <line x1="357" y1="56" x2="357" y2="64"/>
                    <line x1="357" y1="64" x2="348" y2="64"/>
                    <line x1="391" y1="64" x2="391" y2="72"/>
                    <line x1="391" y1="64" x2="400" y2="64"/>
                    <!-- INT-EDU gap x=248..300 y=228 -->
                    <line x1="257" y1="220" x2="257" y2="228"/>
                    <line x1="257" y1="228" x2="248" y2="228"/>
                    <line x1="291" y1="228" x2="291" y2="236"/>
                    <line x1="291" y1="228" x2="300" y2="228"/>
                    <!-- EDU-SOC gap x=448..500 y=228 -->
                    <line x1="457" y1="220" x2="457" y2="228"/>
                    <line x1="457" y1="228" x2="448" y2="228"/>
                    <line x1="491" y1="228" x2="491" y2="236"/>
                    <line x1="491" y1="228" x2="500" y2="228"/>
                </g>

                <!-- LED segments (amber/yellow, at gap midpoints) -->
                <g class="circuit-leds" fill="rgba(215,185,0,0.9)" filter="url(#cled)">
                    <!-- STR-DEX midpoint x=174 -->
                    <rect x="165" y="60" width="4" height="8" rx="1"/>
                    <rect x="172" y="60" width="4" height="8" rx="1"/>
                    <rect x="179" y="60" width="4" height="8" rx="1"/>
                    <!-- DEX-END midpoint x=374 -->
                    <rect x="365" y="60" width="4" height="8" rx="1"/>
                    <rect x="372" y="60" width="4" height="8" rx="1"/>
                    <rect x="379" y="60" width="4" height="8" rx="1"/>
                    <!-- INT-EDU midpoint x=274 -->
                    <rect x="265" y="224" width="4" height="8" rx="1"/>
                    <rect x="272" y="224" width="4" height="8" rx="1"/>
                    <rect x="279" y="224" width="4" height="8" rx="1"/>
                    <!-- EDU-SOC midpoint x=474 -->
                    <rect x="465" y="224" width="4" height="8" rx="1"/>
                    <rect x="472" y="224" width="4" height="8" rx="1"/>
                    <rect x="479" y="224" width="4" height="8" rx="1"/>
                </g>
            </svg>

            <!-- ─── Row 1: STR DEX END ─────────────────────────── -->
            <div class="hex-row row-1">
                @for (char of characteristicsList.slice(0, 3); track char; let i = $index) {
                    <div class="hex-wrap"
                         [class.selected]="selectedStat === char"
                         [class.rolling]="rollingState[char]"
                         [class.glitch]="glitchState[char]"
                         [class.complete]="isComplete"
                         (click)="selectCard(char)">
                        <div class="hex-ring r1"></div>
                        <div class="hex-ring r2"></div>
                        <div class="hex-ring r3"></div>
                        <div class="hex-ring r4"></div>
                        <div class="hex-cell">
                            @if (rollingState[char]) {
                                <div class="hex-scan-beam"></div>
                            }
                            <div class="hex-content">
                                <span class="hex-index">[ 0{{ i + 1 }} ]</span>
                                <span class="hex-name">{{ char }}</span>
                                @if (!editingState[char]) {
                                    <span class="hex-value" [class.zero]="getScore(char) === 0">
                                        {{ getScore(char) || '—' }}
                                    </span>
                                    <span class="hex-mod"
                                          [class.pos]="getModifier(char) > 0"
                                          [class.neg]="getModifier(char) < 0"
                                          [class.visible]="getScore(char) > 0">
                                        {{ getModifier(char) >= 0 ? '+' : '' }}{{ getModifier(char) }}
                                    </span>
                                }
                                @if (editingState[char]) {
                                    <input type="number" class="hex-edit-input"
                                        [ngModel]="getScore(char)"
                                        (ngModelChange)="updateScore(char, $event)"
                                        (blur)="stopEditing(char)"
                                        (keyup.enter)="stopEditing(char)"
                                        (click)="$event.stopPropagation()"
                                        autoFocus>
                                }
                            </div>
                        </div>
                        @if (!editingState[char] && isComplete) {
                            <div class="hex-edit-btn" (click)="startEditing(char, $event)" title="Edit">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                     stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M12 20h9"></path>
                                    <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path>
                                </svg>
                            </div>
                        }
                    </div>
                }
            </div>

            <!-- ─── Row 2: INT EDU SOC ─────────────────────────── -->
            <div class="hex-row row-2">
                @for (char of characteristicsList.slice(3, 6); track char; let i = $index) {
                    <div class="hex-wrap"
                         [class.selected]="selectedStat === char"
                         [class.rolling]="rollingState[char]"
                         [class.glitch]="glitchState[char]"
                         [class.complete]="isComplete"
                         (click)="selectCard(char)">
                        <div class="hex-ring r1"></div>
                        <div class="hex-ring r2"></div>
                        <div class="hex-ring r3"></div>
                        <div class="hex-ring r4"></div>
                        <div class="hex-cell">
                            @if (rollingState[char]) {
                                <div class="hex-scan-beam"></div>
                            }
                            <div class="hex-content">
                                <span class="hex-index">[ 0{{ i + 4 }} ]</span>
                                <span class="hex-name">{{ char }}</span>
                                @if (!editingState[char]) {
                                    <span class="hex-value" [class.zero]="getScore(char) === 0">
                                        {{ getScore(char) || '—' }}
                                    </span>
                                    <span class="hex-mod"
                                          [class.pos]="getModifier(char) > 0"
                                          [class.neg]="getModifier(char) < 0"
                                          [class.visible]="getScore(char) > 0">
                                        {{ getModifier(char) >= 0 ? '+' : '' }}{{ getModifier(char) }}
                                    </span>
                                }
                                @if (editingState[char]) {
                                    <input type="number" class="hex-edit-input"
                                        [ngModel]="getScore(char)"
                                        (ngModelChange)="updateScore(char, $event)"
                                        (blur)="stopEditing(char)"
                                        (keyup.enter)="stopEditing(char)"
                                        (click)="$event.stopPropagation()"
                                        autoFocus>
                                }
                            </div>
                        </div>
                        @if (!editingState[char] && isComplete) {
                            <div class="hex-edit-btn" (click)="startEditing(char, $event)" title="Edit">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                     stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M12 20h9"></path>
                                    <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path>
                                </svg>
                            </div>
                        }
                    </div>
                }
            </div>

        </div>
    </div>

    <!-- Bottom control bar -->
    <div class="biometric-control">
        @if (!isComplete) {
            <button class="btn-sequence" (click)="rollSequence()" [disabled]="isRolling">
                <span class="btn-hex-icon">⬡</span>
                <span class="btn-text">{{ isRolling ? 'SEQUENCING...' : 'INITIALIZE_BIOMETRIC_ROLL' }}</span>
            </button>
            @if (!isRolling) {
                <p class="ctrl-hint">> STANDBY: AWAITING_BIOMETRIC_SEQUENCE_TRIGGER</p>
            }
        }
        @if (isComplete) {
            <div class="ctrl-status">
                <span class="status-dot"></span>
                <span class="status-text">STATUS: SEQUENCE_COMPLETE // SWAP_ENABLED</span>
            </div>
            <p class="ctrl-hint">SELECT_TWO_HEXES_TO_SWAP_ALLOCATION</p>
        }
    </div>
</div>
